# Goondan Sample 2: Telegram Coder Agent
# 텔레그램을 통해 코딩 작업을 수행하는 에이전트
apiVersion: agents.example.io/v1alpha1
kind: Model
metadata:
  name: default-model
spec:
  provider: anthropic
  name: claude-sonnet-4-5

---
apiVersion: agents.example.io/v1alpha1
kind: Agent
metadata:
  name: coder
spec:
  modelConfig:
    modelRef: { kind: Model, name: default-model }
    params:
      temperature: 0.3
      maxTokens: 8192

  prompts:
    systemRef: "./prompts/coder.system.md"

  tools:
    # 코드 도구
    - { kind: Tool, name: code }
    # Git 도구
    - { kind: Tool, name: git }

  extensions:
    # 메시지 압축 (긴 대화 관리)
    - { kind: Extension, name: compaction }

---
apiVersion: agents.example.io/v1alpha1
kind: Swarm
metadata:
  name: default
spec:
  entrypoint: { kind: Agent, name: coder }
  agents:
    - { kind: Agent, name: coder }
  policy:
    maxStepsPerTurn: 16

---
apiVersion: agents.example.io/v1alpha1
kind: Connector
metadata:
  name: telegram
spec:
  type: telegram

  # Bot Token 설정
  # 방법 1: 환경변수 (권장)
  botToken:
    valueFrom:
      env: "TELEGRAM_BOT_TOKEN"

  # 방법 2: 직접 값 (비권장, 테스트용)
  # botToken:
  #   value: "123456789:ABCDEF..."

  # Long Polling 설정
  polling:
    enabled: true
    timeout: 30

  # Webhook 설정 (polling과 배타적)
  # webhook:
  #   enabled: true
  #   url: "https://your-domain.com/webhook/telegram"
  #   secret: "your-webhook-secret"

  # 메시지 수신 규칙
  ingress:
    # /code 명령어로 코딩 에이전트 호출
    - match:
        command: "/code"
      route:
        swarmRef: { kind: Swarm, name: default }

    # /help 명령어
    - match:
        command: "/help"
      route:
        swarmRef: { kind: Swarm, name: default }

    # 그 외 모든 메시지 (봇이 멘션되거나 private chat인 경우)
    - route:
        swarmRef: { kind: Swarm, name: default }

  # 메시지 송신 설정
  egress:
    parseMode: Markdown

---
# CLI Connector (테스트용)
apiVersion: agents.example.io/v1alpha1
kind: Connector
metadata:
  name: cli
spec:
  type: cli
  ingress:
    - route:
        swarmRef: { kind: Swarm, name: default }
        instanceKeyFrom: "$.instanceKey"
        inputFrom: "$.text"
